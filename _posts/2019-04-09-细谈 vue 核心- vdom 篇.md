---
layout: post
title: "ç»†è°ˆ vue æ ¸å¿ƒ- vdom ç¯‡"
date: 2019-04-09 
description: "ç»†è°ˆ vue æ ¸å¿ƒ- vdom ç¯‡"
tag: vue æºç 
---  

å¾ˆæ—©ä¹‹å‰ï¼Œæˆ‘æ›¾å†™è¿‡ä¸€ç¯‡æ–‡ç« ï¼Œåˆ†æå¹¶å®ç°è¿‡ä¸€ç‰ˆç®€æ˜“çš„ `vdom`ã€‚æƒ³çœ‹çš„å¯ä»¥ç‚¹å‡» [ä¼ é€é—¨](https://xuqiang521.github.io/2018/03/Virtual-Dom-&&-Diff/)

èŠèŠä¸ºä»€ä¹ˆåˆæƒ³ç€å†™è¿™ä¹ˆä¸€ç¯‡æ–‡ç« ï¼Œå®åœ¨æ˜¯é¡¹ç›®é‡Œï¼Œä¸ç®¡è‡ªå·±è¿˜æ˜¯åŒäº‹ï¼Œéƒ½æˆ–å¤šæˆ–å°‘ä¼šé‡åˆ°è¿™å—çš„å‘ã€‚æ‰€ä»¥è¿™é‡Œå½“ç»™å°ä¼™ä¼´ä»¬å†åšä¸€æ¬¡æ€»ç»“å§ï¼Œå¸Œæœ›å¤§ä¼™çœ‹å®Œï¼Œèƒ½å¯¹ `vue` ä¸­çš„ `vdom` æœ‰ä¸€ä¸ªæ›´å¥½çš„è®¤çŸ¥ã€‚å¥½äº†ï¼Œæ¥ä¸‹æ¥ç›´æ¥å¼€å§‹å§

## ä¸€ã€æŠ›å‡ºé—®é¢˜

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘å…ˆæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¤§å®¶å¯ä»¥å…ˆæ€è€ƒï¼Œç„¶åå†æ¥ç€é˜…è¯»åé¢çš„ç¯‡å¹…ã€‚å…ˆä¸Šä¸‹ä»£ç 
```html
<template>
  <el-select
    class="test-select"
    multiple
    filterable
    remote
    placeholder="è¯·è¾“å…¥å…³é”®è¯"
    :remote-method="remoteMethod"
    :loading="loading"
    @focus="handleFoucs"
    v-model="items">
    <!-- è¿™é‡Œ option çš„ key ç›´æ¥ç»‘å®š vfor çš„ index -->
    <el-option
      v-for="(item, index) in options"
      :key="index"
      :label="item.label"
      :value="item.value">
      <el-checkbox
        :label="item.value"
        :value="isChecked(item.value)">
        {{ item.label }}
      </el-checkbox>
    </el-option>
  </el-select>
</template>

<script lang="ts">
import { Component, Vue } from 'vue-property-decorator'

@Component
export default class TestSelect extends Vue {
  options: Array<{ label: string, value: string }> = []
  items: Array<string> = []
  list: Array<{ label: string, value: string }> = []
  loading: boolean = false
  states = ['Alabama', 'Alaska', 'Arizona',
    'Arkansas', 'California', 'Colorado',
    'Connecticut', 'Delaware', 'Florida',
    'Georgia', 'Hawaii', 'Idaho', 'Illinois',
    'Indiana', 'Iowa', 'Kansas', 'Kentucky',
    'Louisiana', 'Maine', 'Maryland',
    'Massachusetts', 'Michigan', 'Minnesota',
    'Mississippi', 'Missouri', 'Montana',
    'Nebraska', 'Nevada', 'New Hampshire',
    'New Jersey', 'New Mexico', 'New York',
    'North Carolina', 'North Dakota', 'Ohio',
    'Oklahoma', 'Oregon', 'Pennsylvania',
    'Rhode Island', 'South Carolina',
    'South Dakota', 'Tennessee', 'Texas',
    'Utah', 'Vermont', 'Virginia',
    'Washington', 'West Virginia', 'Wisconsin',
    'Wyoming']

  mounted () {
    this.list = this.states.map(item => {
      return { value: item, label: item }
    })
  }

  remoteMethod (query) {
    if (query !== '') {
      this.loading = true
      setTimeout(() => {
        this.loading = false
        this.options = this.list.filter(item => {
          return item.label.toLowerCase()
            .indexOf(query.toLowerCase()) > -1
        })
      }, 200)
    } else {
      this.options = this.list
    }
  }

  handleFoucs (e) {
    this.remoteMethod(e.target.value)
  }

  isChecked (value: string): boolean {
    let checked = false
    this.items.forEach((item: string) => {
      if (item === value) {
        checked = true
      }
    })
    return checked
  }
}
</script>
```
è¾“å…¥ç­›é€‰åæ•ˆæœå›¾å¦‚ä¸‹

![](https://user-gold-cdn.xitu.io/2019/4/8/169fccbbdf128e5c?w=866&h=850&f=png&s=49865)

ç„¶åæˆ‘åœ¨æ¢ä¸€ä¸ªå…³é”®è¯è¿›è¡Œæœç´¢ï¼Œç»“æœå°±ä¼šå‡ºç°ä»¥ä¸‹å±•ç¤ºçš„é—®é¢˜

![](https://user-gold-cdn.xitu.io/2019/4/8/169fccc124f26e9f?w=810&h=754&f=png&s=51215)

æˆ‘å¹¶æ²¡æœ‰è¿›è¡Œé€‰æ‹©ï¼Œä½†æ˜¯ select é€‰æ‹©æ¡†ä¸­å±•ç¤ºçš„å€¼å´å‘ç”Ÿäº†å˜æ›´ã€‚è€å¸æœºå¯èƒ½ä¸€å¼€å§‹çœ‹ä»£ç ï¼Œå°±çŸ¥é“é—®é¢˜æ‰€åœ¨äº†ã€‚å…¶å®æŠŠ option é‡Œé¢çš„ `key` ç»‘å®šæ¢ä¸€ä¸‹å°±OKï¼Œæ¢æˆå¦‚ä¸‹çš„
```html
<el-option
  v-for="item in options"
  :key="item.value"
  :label="item.label"
  :value="item.value">
  <el-checkbox
    :label="item.value"
    :value="isChecked(item.value)">
    {{ item.label }}
  </el-checkbox>
</el-option>
```
é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™æ ·å¯ä»¥é¿å…é—®é¢˜ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆå¯ä»¥é¿å…å‘¢ï¼Ÿå…¶å®ï¼Œè¿™å—å°±ç‰µæ‰¯åˆ° vdom é‡Œ patch ç›¸å…³çš„å†…å®¹äº†ã€‚æ¥ä¸‹æ¥æˆ‘å°±å¸¦ç€å¤§å®¶é‡æ–°æŠŠ vdom å†æ¡èµ·æ¥ä¸€æ¬¡

å¼€å§‹ä¹‹å‰ï¼Œçœ‹å‡ ä¸ªä¸‹æ–‡ä¸­ç»å¸¸å‡ºç°çš„ API

- `isDef() `
```javascript
export function isDef (v: any): boolean %checks {
  return v !== undefined && v !== null
}
```
- `isUndef()`
```javascript
export function isUndef (v: any): boolean %checks {
  return v === undefined || v === null
}
```
- `isTrue()`
```javascript
export function isTrue (v: any): boolean %checks {
  return v === true
}
```
## äºŒã€class VNode

å¼€ç¯‡å‰ï¼Œå…ˆè®²ä¸€ä¸‹ **VNode** ï¼Œ`vue` ä¸­çš„ `vdom` å…¶å®å°±æ˜¯ä¸€ä¸ª `vnode` å¯¹è±¡ã€‚

å¯¹ `vdom` ç¨ä½œäº†è§£çš„åŒå­¦éƒ½åº”è¯¥çŸ¥é“ï¼Œ`vdom` åˆ›å»ºèŠ‚ç‚¹çš„æ ¸å¿ƒé¦–å…ˆå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¯¹çœŸå® dom æŠ½è±¡çš„ js å¯¹è±¡æ ‘ï¼Œç„¶åé€šè¿‡ä¸€ç³»åˆ—æ“ä½œï¼ˆåé¢æˆ‘å†è°ˆå…·ä½“ä»€ä¹ˆæ“ä½œï¼‰ã€‚è¯¥ç« èŠ‚æˆ‘ä»¬å°±åªè°ˆ `vnode` çš„å®ç°

### ***1ã€constructor***

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹ï¼Œ ***VNode*** è¿™ä¸ªç±»å¯¹æˆ‘ä»¬è¿™äº›ä½¿ç”¨è€…æš´éœ²äº†å“ªäº›å±æ€§å‡ºæ¥ï¼ŒæŒ‘ä¸€äº›æˆ‘ä»¬å¸¸è§çš„çœ‹

```javascript
constructor (
  tag?: string,
  data?: VNodeData,
  children?: ?Array<VNode>,
  text?: string,
  elm?: Node,
  context?: Component
) {
  this.tag = tag  // èŠ‚ç‚¹çš„æ ‡ç­¾å
  this.data = data // èŠ‚ç‚¹çš„æ•°æ®ä¿¡æ¯ï¼Œå¦‚ propsï¼Œattrsï¼Œkeyï¼Œclassï¼Œdirectives ç­‰
  this.children = children // èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
  this.text = text // èŠ‚ç‚¹å¯¹åº”çš„æ–‡æœ¬
  this.elm = elm  // èŠ‚ç‚¹å¯¹åº”çš„çœŸå®èŠ‚ç‚¹
  this.context = context // èŠ‚ç‚¹ä¸Šä¸‹æ–‡ï¼Œä¸º Vue Component çš„å®šä¹‰
  this.key = data && data.key // èŠ‚ç‚¹ç”¨ä½œ diff çš„å”¯ä¸€æ ‡è¯†
}
```

### ***2ã€for example***

ç°åœ¨ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚æˆ‘éœ€è¦è§£æä¸‹é¢æ–‡æœ¬

```html
<template>
  <div class="vnode" :class={ 'show-node': isShow } v-show="isShow">
    This is a vnode.
  </div>
</template>
```

ä½¿ç”¨ js è¿›è¡ŒæŠ½è±¡å°±æ˜¯è¿™æ ·çš„

```javascript
function render () {
  return new VNode(
    'div',
    {
      // é™æ€ class
      staticClass: 'vnode',
      // åŠ¨æ€ class
      class: {
        'show-node': isShow
      },
      /**
        * directives: [
        *  {
        *    rawName: 'v-show',
        *    name: 'show',
        *    value: isShow
        *  }
        * ],
        */
      // ç­‰åŒäº directives é‡Œé¢çš„ v-show
      show: isShow,
      [ new VNode(undefined, undefined, undefined, 'This is a vnode.') ]
    }
  )
}
```

è½¬æ¢æˆ vnode åçš„è¡¨ç°å½¢å¼å¦‚ä¸‹

```javascript
{
  tag: 'div',
  data: {
    show: isShow,
    // é™æ€ class
    staticClass: 'vnode',
    // åŠ¨æ€ class
    class: {
      'show-node': isShow
    },
  },
  text: undefined,
  children: [
    {
      tag: undefined,
      data: undefined,
      text: 'This is a vnode.',
      children: undefined
    }
  ]
}
```

ç„¶åæˆ‘å†çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹çš„ä¾‹å­

```html
<span v-for="n in 5" :key="n">{{ n }}</span>
```

å‡å¦‚è®©å¤§å®¶ä½¿ç”¨ js å¯¹å…¶è¿›è¡Œå¯¹è±¡æŠ½è±¡ï¼Œå¤§å®¶ä¼šå¦‚ä½•è¿›è¡Œå‘¢ï¼Ÿä¸»è¦æ˜¯é‡Œé¢çš„ **v-for** æŒ‡ä»¤ï¼Œå¤§å®¶å¯ä»¥å…ˆè‡ªå·±å¸¦ç€æ€è€ƒè¯•è¯•ã€‚

OKï¼Œä¸å–å…³å­ï¼Œæˆ‘ä»¬ç°åœ¨ç›´æ¥çœ‹çœ‹ä¸‹é¢çš„ render å‡½æ•°å¯¹å…¶çš„æŠ½è±¡å¤„ç†ï¼Œå…¶å®å°±æ˜¯å¾ªç¯ render å•¦!
![](https://user-gold-cdn.xitu.io/2019/4/8/169fcd17624160a2?w=54&h=54&f=png&s=3886)

```javascript
function render (val, keyOrIndex, index) {
  return new VNode(
    'span',
    {
      directives: [
        {
          rawName: 'v-for',
          name: 'for',
          value: val
        }
      ],
      key: val,
      [ new VNode(undefined, undefined, undefined, val) ]
    }
  )
}
function renderList (
  val: any,
  render: (
    val: any,
    keyOrIndex: string | number,
    index?: number
  ) => VNode
): ?Array<VNode> {
  // ä»…è€ƒè™‘ number çš„æƒ…å†µ
  let ret: ?Array<VNode>, i, l, keys, key
  ret = new Array(val)
  for (i = 0; i < val; i++) {
    ret[i] = render(i + 1, i)
  }
  return ret
}
renderList(5)
```

è½¬æ¢æˆ vnode åçš„è¡¨ç°å½¢å¼å¦‚ä¸‹

```javascript
[
  {
    tag: 'span',
    data: {
      key: 1
    },
    text: undefined,
    children: [
      {
        tag: undefined,
        data: undefined,
        text: 1,
        children: undefined
      }
    ]
  }
  // ä¾æ¬¡å¾ªç¯
]
```

### ***3ã€something else***

æˆ‘ä»¬çœ‹å®Œäº† `VNode Ctor` çš„ä¸€äº›å±æ€§ï¼Œä¹Ÿçœ‹äº†ä¸€ä¸‹å¯¹äºçœŸå® dom vnode çš„è½¬æ¢å½¢å¼ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ç¨å¾®è¡¥ä¸ªæ¼ï¼Œçœ‹çœ‹åŸºäº `VNode` åšçš„ä¸€äº›å°è£…ç»™æˆ‘ä»¬æš´éœ²çš„ä¸€äº›æ–¹æ³•

```javascript
// åˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹
export const createEmptyVNode = (text: string = '') => {
  const node = new VNode()
  node.text = text
  node.isComment = true
  return node
}
// åˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹
export function createTextVNode (val: string | number) {
  return new VNode(undefined, undefined, undefined, String(val))
}
// å…‹éš†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»…åˆ—ä¸¾éƒ¨åˆ†å±æ€§
export function cloneVNode (vnode: VNode): VNode {
  const cloned = new VNode(
    vnode.tag,
    vnode.data,
    vnode.children,
    vnode.text
  )
  cloned.key = vnode.key
  cloned.isCloned = true
  return cloned
}
```

æ‹æ¸…æ¥š `VNode` ç›¸å…³æ–¹æ³•ï¼Œä¸‹é¢çš„ç« èŠ‚ï¼Œå°†ä»‹ç» `vue` æ˜¯å¦‚ä½•å°† `vnode` æ¸²æŸ“æˆçœŸå® `dom`

## ä¸‰ã€render

### ***1ã€createElement***

åœ¨çœ‹ vue ä¸­ createElement çš„å®ç°å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹åŒæ–‡ä»¶ä¸‹ç§æœ‰æ–¹æ³• `_createElement` çš„å®ç°ã€‚å…¶ä¸­æ˜¯å¯¹ tag å…·ä½“çš„ä¸€äº›é€»è¾‘åˆ¤å®š

- tagName ç»‘å®šåœ¨ data å‚æ•°é‡Œé¢

```javascript
if (isDef(data) && isDef(data.is)) {
  tag = data.is
}
```

- tagName ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›ä¸€ä¸ªç©ºèŠ‚ç‚¹

```javascript
if (!tag) {
  return createEmptyVNode()
}
```

- tagName æ˜¯ string ç±»å‹çš„æ—¶å€™ï¼Œç›´æ¥è¿”å›å¯¹åº” tag çš„ vnode å¯¹è±¡

```javascript
vnode = new VNode(
  tag, data, children,
  undefined, undefined, context
)
```

- tagName æ˜¯é string ç±»å‹çš„æ—¶å€™ï¼Œåˆ™æ‰§è¡Œ `createComponent()` åˆ›å»ºä¸€ä¸ª **Component** å¯¹è±¡

```javascript
vnode = createComponent(tag, data, context, children)
```

- åˆ¤å®š vnode ç±»å‹ï¼Œè¿›è¡Œå¯¹åº”çš„è¿”å›

```javascript
if (Array.isArray(vnode)) {
  return vnode
} else if (isDef(vnode)) {
  // namespace ç›¸å…³å¤„ç†
  if (isDef(ns)) applyNS(vnode, ns)
  // è¿›è¡Œ Observer ç›¸å…³ç»‘å®š
  if (isDef(data)) registerDeepBindings(data)
  return vnode
} else {
  return createEmptyVNode()
}
```

`createElement()` åˆ™æ˜¯æ‰§è¡Œ `_createElement()` è¿”å› vnode

```javascript
return _createElement(context, tag, data, children, normalizationType)
```

### ***2ã€render functions***

#### i. renderHelpers

è¿™é‡Œæˆ‘ä»¬å…ˆæ•´ä½“çœ‹ä¸‹ï¼ŒæŒ‚è½½åœ¨ `Vue.prototype` ä¸Šçš„éƒ½æœ‰å“ªäº› render ç›¸å…³çš„æ–¹æ³•

```javascript
export function installRenderHelpers (target: any) {
  target._o = markOnce // v-once render å¤„ç†
  target._n = toNumber // å€¼è½¬æ¢ Number å¤„ç†
  target._s = toString // å€¼è½¬æ¢ String å¤„ç†
  target._l = renderList // v-for render å¤„ç†
  target._t = renderSlot // slot æ§½ç‚¹ render å¤„ç†
  target._q = looseEqual // åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦å¤§ä½“ç›¸ç­‰
  target._i = looseIndexOf // å¯¹ç­‰å±æ€§ç´¢å¼•ï¼Œä¸å­˜åœ¨åˆ™è¿”å› -1
  target._m = renderStatic // é™æ€èŠ‚ç‚¹ render å¤„ç†
  target._f = resolveFilter // filters æŒ‡ä»¤ render å¤„ç†
  target._k = checkKeyCodes // checking keyCodes from config
  target._b = bindObjectProps // v-bind render å¤„ç†ï¼Œå°† v-bind="object" çš„å±æ€§ merge åˆ°VNodeå±æ€§ä¸­
  target._v = createTextVNode // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
  target._e = createEmptyVNode // åˆ›å»ºç©ºèŠ‚ç‚¹
  target._u = resolveScopedSlots // scopeSlots render å¤„ç†
  target._g = bindObjectListeners // v-on render å¤„ç†
}
```

ç„¶ååœ¨ `renderMixin()` æ–¹æ³•ä¸­ï¼Œå¯¹  `Vue.prototype` è¿›è¡Œ init æ“ä½œ

```javascript
export function renderMixin (Vue: Class<Component>) {
  // render helps init æ“ä½œ
  installRenderHelpers(Vue.prototype)

  // å®šä¹‰ vue nextTick æ–¹æ³•
  Vue.prototype.$nextTick = function (fn: Function) {
    return nextTick(fn, this)
  }

  Vue.prototype._render = function (): VNode {
    // æ­¤å¤„å®šä¹‰ vm å®ä¾‹ï¼Œä»¥åŠ return vnodeã€‚å…·ä½“ä»£ç æ­¤å¤„å¿½ç•¥
  }
}
```

#### ii. AST æŠ½è±¡è¯­æ³•æ ‘

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„ `render` ç›¸å…³çš„æ“ä½œéƒ½æ˜¯è¿”å›ä¸€ä¸ª `vnode` å¯¹è±¡ï¼Œè€ŒçœŸå®èŠ‚ç‚¹çš„æ¸²æŸ“ä¹‹å‰ï¼Œvue ä¼šå¯¹ template æ¨¡æ¿ä¸­çš„å­—ç¬¦ä¸²è¿›è¡Œè§£æï¼Œå°†å…¶è½¬æ¢æˆ AST æŠ½è±¡è¯­æ³•æ ‘ï¼Œæ–¹ä¾¿åç»­çš„æ“ä½œã€‚å…³äºè¿™å—ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹çœ‹ vue ä¸­åœ¨ flow ç±»å‹é‡Œé¢æ˜¯å¦‚ä½•å®šä¹‰ `ASTElement` æ¥å£ç±»å‹çš„ï¼Œæ—¢ç„¶æ˜¯å¼€ç¯‡æŠ›å‡ºçš„é—®é¢˜æ˜¯ç”± `v-for` å¯¼è‡´çš„ï¼Œé‚£ä¹ˆè¿™å—ï¼Œæˆ‘ä»¬å°±ä»…ä»…çœ‹çœ‹ `ASTElement` å¯¹å…¶çš„å®šä¹‰ï¼Œçœ‹å®Œä¹‹åè®°å¾—ä¸¾ä¸€åä¸‰å»æºç é‡Œé¢ç†è§£å…¶ä»–çš„å®šä¹‰å“¦ğŸ’ª

```javascript
declare type ASTElement = {
  tag: string; // æ ‡ç­¾å
  attrsMap: { [key: string]: any }; // æ ‡ç­¾å±æ€§ map
  parent: ASTElement | void; // çˆ¶æ ‡ç­¾
  children: Array<ASTNode>; // å­èŠ‚ç‚¹

  for?: string; // è¢« v-for çš„å¯¹è±¡
  forProcessed?: boolean; // v-for æ˜¯å¦éœ€è¦è¢«å¤„ç†
  key?: string; // v-for çš„ key å€¼
  alias?: string; // v-for çš„å‚æ•°
  iterator1?: string; // v-for ç¬¬ä¸€ä¸ªå‚æ•°
  iterator2?: string; // v-for ç¬¬äºŒä¸ªå‚æ•°
};
```

#### iii. generate å­—ç¬¦ä¸²è½¬æ¢

- `renderList` 

åœ¨çœ‹ `render function` å­—ç¬¦ä¸²è½¬æ¢ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹ `renderList`  çš„å‚æ•°ï¼Œæ–¹ä¾¿åé¢çš„é˜…è¯»

```javascript
export function renderList (
  val: any,
  render: (
    val: any,
    keyOrIndex: string | number,
    index?: number
  ) => VNode
): ?Array<VNode> {
  // æ­¤å¤„ä¸º render ç›¸å…³å¤„ç†ï¼Œå…·ä½“ç»†èŠ‚è¿™é‡Œå°±ä¸åˆ—å‡ºæ¥äº†ï¼Œä¸Šæ–‡ä¸­æœ‰åˆ—å‡º number æƒ…å†µçš„å¤„ç†
}
```

- `genFor`

ä¸Šé¢çœ‹å®Œå®šä¹‰ï¼Œç´§æ¥ç€æˆ‘ä»¬å†æ¥çœ‹çœ‹ï¼Œ`generate` æ˜¯å¦‚ä½•å°† AST è½¬æ¢æˆ render function å­—ç¬¦ä¸²çš„ï¼Œè¿™æ ·åŒç†æˆ‘ä»¬å°±çœ‹å¯¹ `v-for` ç›¸å…³çš„å¤„ç†

```javascript
function genFor (
  el: any,
  state: CodegenState,
  altGen?: Function,
  altHelper?: string
): string {
  const exp = el.for // v-for çš„å¯¹è±¡
  const alias = el.alias // v-for çš„å‚æ•°
  const iterator1 = el.iterator1 ? `,${el.iterator1}` : '' // v-for ç¬¬ä¸€ä¸ªå‚æ•°
  const iterator2 = el.iterator2 ? `,${el.iterator2}` : '' // v-for ç¬¬äºŒä¸ªå‚æ•°
  el.forProcessed = true // æŒ‡ä»¤éœ€è¦è¢«å¤„ç†
  // return å‡ºå¯¹åº” render function å­—ç¬¦ä¸²
  return `${altHelper || '_l'}((${exp}),` +
    `function(${alias}${iterator1}${iterator2}){` +
      `return ${(altGen || genElement)(el, state)}` +
    '})'
}
```

- `genElement`

è¿™å—é›†æˆäº†å„ä¸ªæŒ‡ä»¤å¯¹åº”çš„è½¬æ¢é€»è¾‘

```javascript
export function genElement (el: ASTElement, state: CodegenState): string {
  if (el.staticRoot && !el.staticProcessed) { // é™æ€èŠ‚ç‚¹
    return genStatic(el, state)
  } else if (el.once && !el.onceProcessed) { // v-once å¤„ç†
    return genOnce(el, state)
  } else if (el.for && !el.forProcessed) { // v-for å¤„ç†
    return genFor(el, state)
  } else if (el.if && !el.ifProcessed) { // v-if å¤„ç†
    return genIf(el, state)
  } else if (el.tag === 'template' && !el.slotTarget) { // template æ ¹èŠ‚ç‚¹å¤„ç†
    return genChildren(el, state) || 'void 0'
  } else if (el.tag === 'slot') { // slot èŠ‚ç‚¹å¤„ç†
    return genSlot(el, state)
  } else {
    // component or element ç›¸å…³å¤„ç†
  }
}
```

- `generate`

`generate` åˆ™æ˜¯å°†ä»¥ä¸Šæ‰€æœ‰çš„æ–¹æ³•é›†æˆåˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œå…¶ä¸­ `render` å±æ€§å¯¹åº”çš„åˆ™æ˜¯ `genElement` ç›¸å…³çš„æ“ä½œï¼Œ`staticRenderFns` å¯¹åº”çš„åˆ™æ˜¯å­—ç¬¦ä¸²æ•°ç»„ã€‚

```javascript
export function generate (
  ast: ASTElement | void,
  options: CompilerOptions
): CodegenResult {
  const state = new CodegenState(options)
  const code = ast ? genElement(ast, state) : '_c("div")'
  return {
    render: `with(this){return ${code}}`, // render
    staticRenderFns: state.staticRenderFns // render function å­—ç¬¦ä¸²æ•°ç»„
  }
}
```

### ***3ã€render æ —å­***

çœ‹äº†ä¸Šé¢è¿™ä¹ˆå¤šï¼Œå¯¹ vue ä¸å¤ªäº†è§£çš„ä¸€äº›å°ä¼™ä¼´å¯èƒ½ä¼šè§‰å¾—æœ‰äº›æ™•ï¼Œè¿™é‡Œç›´æ¥ä¸¾ä¸€ä¸ª `v-for` æ¸²æŸ“çš„ä¾‹å­ç»™å¤§å®¶æ¥ç†è§£ã€‚

#### i. demo

```html
<div class="root">
  <span v-for="n in 5" :key="n">{{ n }}</span>
</div>
```

è¿™å—é¦–å…ˆä¼šè¢«è§£ææˆ html å­—ç¬¦ä¸²

```javascript
let html = `<div class="root">
  <span v-for="n in 5" :key="n">{{ n }}</span>
</div>`
```

#### ii. ç›¸å…³æ­£åˆ™

æ‹¿åˆ° template é‡Œé¢çš„ html å­—ç¬¦ä¸²ä¹‹åï¼Œä¼šå¯¹å…¶è¿›è¡Œè§£ææ“ä½œã€‚å…·ä½“ç›¸å…³çš„æ­£åˆ™è¡¨è¾¾å¼åœ¨ `src/compiler/parser/html-parser.js` é‡Œé¢æœ‰æåŠï¼Œä»¥ä¸‹æ˜¯ç›¸å…³çš„ä¸€äº›æ­£åˆ™è¡¨è¾¾å¼ä»¥åŠ `decoding map` çš„å®šä¹‰ã€‚

```javascript
const attribute = /^\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/
const ncname = '[a-zA-Z_][\\w\\-\\.]*'
const qnameCapture = `((?:${ncname}\\:)?${ncname})`
const startTagOpen = new RegExp(`^<${qnameCapture}`)
const startTagClose = /^\s*(\/?)>/
const endTag = new RegExp(`^<\\/${qnameCapture}[^>]*>`)
const doctype = /^<!DOCTYPE [^>]+>/i
const comment = /^<!\--/
const conditionalComment = /^<!\[/

const decodingMap = {
  '&lt;': '<',
  '&gt;': '>',
  '&quot;': '"',
  '&amp;': '&',
  '&#10;': '\n',
  '&#9;': '\t'
}
const encodedAttr = /&(?:lt|gt|quot|amp);/g
const encodedAttrWithNewLines = /&(?:lt|gt|quot|amp|#10|#9);/g
```

#### iii. parseHTML

`vue` è§£æ template éƒ½æ˜¯ä½¿ç”¨ `while` å¾ªç¯è¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…çš„ï¼Œæ¯æ¯è§£æå®Œä¸€æ®µå­—ç¬¦ä¸²éƒ½ä¼šå°†å·²ç»åŒ¹é…å®Œçš„éƒ¨åˆ†å»é™¤æ‰ï¼Œç„¶å `index` ç´¢å¼•ä¼šç›´æ¥å¯¹å‰©ä¸‹çš„éƒ¨åˆ†ç»§ç»­è¿›è¡ŒåŒ¹é…ã€‚å…·ä½“æœ‰å…³ `parseHTML` çš„å®šä¹‰å¦‚ä¸‹ï¼Œç”±äºæ–‡ç« åˆ°è¿™ç¯‡å¹…å·²ç»æ¯”è¾ƒé•¿äº†ï¼Œæˆ‘çœç•¥æ‰äº†æ­£åˆ™å¾ªç¯åŒ¹é…æŒ‡é’ˆçš„ä¸€äº›é€»è¾‘ï¼Œæƒ³è¦å…·ä½“äº†è§£çš„å°ä¼™ä¼´å¯ä»¥è‡ªè¡Œç ”ç©¶æˆ–è€…ç­‰æˆ‘ä¸‹æ¬¡å†å‡ºä¸€ç¯‡æ–‡ç« è¯¦è°ˆè¿™å—çš„é€»è¾‘ã€‚

```javascript
export function parseHTML (html, options) {
  const stack = [] // ç”¨æ¥å­˜å‚¨è§£æå¥½çš„æ ‡ç­¾å¤´
  const expectHTML = options.expectHTML
  const isUnaryTag = options.isUnaryTag || no
  const canBeLeftOpenTag = options.canBeLeftOpenTag || no
  let index = 0 // åŒ¹é…æŒ‡é’ˆç´¢å¼•
  let last, lastTag
  while (html) {
    // æ­¤å¤„æ˜¯å¯¹æ ‡ç­¾è¿›è¡Œæ­£åˆ™åŒ¹é…çš„é€»è¾‘
  }
  // æ¸…ç†å‰©ä½™çš„ tags
  parseEndTag()
  // å¾ªç¯åŒ¹é…ç›¸å…³å¤„ç†
  function advance (n) {
    index += n
    html = html.substring(n)
  }
  // èµ·å§‹æ ‡ç­¾ç›¸å…³å¤„ç†
  function parseStartTag () {
    let match = {
      tagName: start[1],
      attrs: [],
      start: index
    }
    // ä¸€ç³»åˆ—åŒ¹é…æ“ä½œï¼Œç„¶åå¯¹ match è¿›è¡Œèµ‹å€¼
  	return match
  }
  function handleStartTag (match) {}
  // ç»“æŸæ ‡ç­¾ç›¸å…³å¤„ç†
  function parseEndTag (tagName, start, end) {}
}
```

ç»è¿‡ `parseHTML()` è¿›è¡Œä¸€ç³»åˆ—æ­£åˆ™åŒ¹é…å¤„ç†ä¹‹åï¼Œä¼šå°†å­—ç¬¦ä¸² html è§£ææˆä»¥ä¸‹ AST çš„å†…å®¹

```javascript
{
  'attrsMap': {
    'class': 'root'
  },
  'staticClass': 'root', // æ ‡ç­¾çš„é™æ€ class
  'tag': 'div', // æ ‡ç­¾çš„ tag
  'children': [{ // å­æ ‡ç­¾æ•°ç»„
    'attrsMap': {
      'v-for': "n in 5",
      'key': n
    },
    'key': n,
    'alias': "n", // v-for å‚æ•°
    'for': 5, // è¢« v-for çš„å¯¹è±¡
    'forProcessed': true,
    'tag': 'span',
    'children': [{
      'expression': '_s(item)', // toString æ“ä½œ(ä¸Šæ–‡æœ‰æåŠ)
      'text': '{{ n }}'
    }]
  }]
}
```

åˆ°è¿™é‡Œï¼Œå†ç»“åˆä¸Šé¢çš„ `generate` è¿›è¡Œè½¬æ¢ä¾¿æ˜¯ `render` è¿™å—çš„é€»è¾‘äº†ã€‚

## å››ã€diff and patch

å“å‘€ï¼Œç»ˆäºåˆ° diff å’Œ patch ç¯èŠ‚äº†ï¼Œæƒ³æƒ³è¿˜æ˜¯å¾ˆé¸¡å†»å‘¢ã€‚

### 1ã€ä¸€äº› DOM çš„ API æ“ä½œ

çœ‹è¿›è¡Œå…·ä½“ diff ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹åœ¨ `platforms/web/runtime/node-ops.js` ä¸­å®šä¹‰çš„ä¸€äº›åˆ›å»ºçœŸå® dom çš„æ–¹æ³•ï¼Œæ­£å¥½æ¸©ä¹ ä¸€ä¸‹ `dom` ç›¸å…³æ“ä½œçš„ API

- `createElement()` åˆ›å»ºç”± **tagName** æŒ‡å®šçš„ HTML å…ƒç´ 

```javascript
export function createElement (tagName: string, vnode: VNode): Element {
  const elm = document.createElement(tagName)
  if (tagName !== 'select') {
    return elm
  }
  if (vnode.data && vnode.data.attrs && vnode.data.attrs.multiple !== undefined) {
    elm.setAttribute('multiple', 'multiple')
  }
  return elm
}
```

- `createTextNode()` åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹

```javascript
export function createTextNode (text: string): Text {
  return document.createTextNode(text)
}
```

- `createComment()` åˆ›å»ºä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹

```javascript
export function createComment (text: string): Comment {
  return document.createComment(text)
}
```

- `insertBefore()` åœ¨å‚è€ƒèŠ‚ç‚¹ä¹‹å‰æ’å…¥ä¸€ä¸ªæ‹¥æœ‰æŒ‡å®šçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹

```javascript
export function insertBefore (parentNode: Node, newNode: Node, referenceNode: Node) {
  parentNode.insertBefore(newNode, referenceNode)
}
```

- `removeChild()` ä» DOM ä¸­åˆ é™¤ä¸€ä¸ªå­èŠ‚ç‚¹

```javascript
export function removeChild (node: Node, child: Node) {
  node.removeChild(child)
}
```

- `appendChild()`  å°†ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°æŒ‡å®šçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨æœ«å°¾

```javascript
export function appendChild (node: Node, child: Node) {
  node.appendChild(child)
}
```

- `parentNode()`  è¿”å›çˆ¶èŠ‚ç‚¹

```javascript
export function parentNode (node: Node): ?Node {
  return node.parentNode
}
```

- `nextSibling()`  è¿”å›å…„å¼ŸèŠ‚ç‚¹

```javascript
export function nextSibling (node: Node): ?Node {
  return node.nextSibling
}
```

- `tagName()`  è¿”å›èŠ‚ç‚¹æ ‡ç­¾å

```javascript
export function tagName (node: Element): string {
  return node.tagName
}
```

- `setTextContent()`  è®¾ç½®èŠ‚ç‚¹æ–‡æœ¬å†…å®¹

```javascript
export function setTextContent (node: Node, text: string) {
  node.textContent = text
}
```

### 2ã€ä¸€äº› patch ä¸­çš„ API æ“ä½œ

æç¤ºï¼šä¸Šé¢æˆ‘ä»¬åˆ—å‡ºæ¥çš„ API éƒ½æŒ‚åœ¨äº†ä¸‹é¢çš„ `nodeOps` å¯¹è±¡ä¸­äº†

- `createElm()` åˆ›å»ºèŠ‚ç‚¹

```javascript
function createElm (vnode, parentElm, refElm) {
  if (isDef(vnode.tag)) { // åˆ›å»ºæ ‡ç­¾èŠ‚ç‚¹
    vnode.elm = nodeOps.createElement(tag, vnode)
  } else if (isDef(vnode.isComment)) { // åˆ›å»ºæ³¨é‡ŠèŠ‚ç‚¹
    vnode.elm = nodeOps.createComment(vnode.text)
  } else { // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
    vnode.elm = nodeOps.createTextNode(vnode.text)
  }
  insert(parentElm, vnode.elm, refElm)
}
```

- `insert()` æŒ‡å®šçˆ¶èŠ‚ç‚¹ä¸‹æ’å…¥å­èŠ‚ç‚¹

```javascript
function insert (parent, elm, ref) {
  if (isDef(parent)) {
    if (isDef(ref)) { // æ’å…¥åˆ°æŒ‡å®š ref çš„å‰é¢
      if (ref.parentNode === parent) {
        nodeOps.insertBefore(parent, elm, ref)
      }
    } else { // ç›´æ¥æ’å…¥åˆ°çˆ¶èŠ‚ç‚¹åé¢
      nodeOps.appendChild(parent, elm)
    }
  }
}
```

- `addVnodes()` æ‰¹é‡è°ƒç”¨ `createElm()` æ¥åˆ›å»ºèŠ‚ç‚¹

```javascript
function addVnodes (parentElm, refElm, vnodes, startIdx, endIdx) {
  for (; startIdx <= endIdx; ++startIdx) {
    createElm(vnodes[startIdx], parentElm, refElm)
  }
}
```

- `removeNode()`  ç§»é™¤èŠ‚ç‚¹

```javascript
function removeNode (el) {
  const parent = nodeOps.parentNode(el)
  if (isDef(parent)) {
    nodeOps.removeChild(parent, el)
  }
}
```

- `removeNodes()`  æ‰¹é‡ç§»é™¤èŠ‚ç‚¹

```javascript
function removeVnodes (parentElm, vnodes, startIdx, endIdx) {
  for (; startIdx <= endIdx; ++startIdx) {
    const ch = vnodes[startIdx]
    if (isDef(ch)) {
      removeNode(ch.elm)
    }
  }
}
```

- `sameVnode()` æ˜¯å¦ä¸ºç›¸åŒèŠ‚ç‚¹

```javascript
function sameVnode (a, b) {
  return (
    a.key === b.key &&
    a.tag === b.tag &&
    a.isComment === b.isComment &&
    isDef(a.data) === isDef(b.data) &&
    sameInputType(a, b)
  )
}
```

- `sameInputType()` æ˜¯å¦æœ‰ç›¸åŒçš„ input type

```javascript
function sameInputType (a, b) {
  if (a.tag !== 'input') return true
  let i
  const typeA = isDef(i = a.data) && isDef(i = i.attrs) && i.type
  const typeB = isDef(i = b.data) && isDef(i = i.attrs) && i.type
  return typeA === typeB
}
```

### 3ã€èŠ‚ç‚¹ diff

#### i. ç›¸å…³æµç¨‹å›¾

è°ˆåˆ°è¿™ï¼Œå…ˆæŒª(ç›—)ç”¨ä¸‹æˆ‘ä»¥å‰æ–‡ç« ä¸­ç›¸å…³çš„ä¸¤å¼ å›¾

![](https://user-gold-cdn.xitu.io/2019/4/8/169fcd6694b2834d?w=932&h=640&f=jpeg&s=52060)

![](https://user-gold-cdn.xitu.io/2019/4/8/169fcd68aec8e397?w=1050&h=864&f=jpeg&s=97362)

#### ii. diffã€patch æ“ä½œåˆäºŒä¸ºä¸€

çœ‹è¿‡æˆ‘ä»¥å‰æ–‡ç« çš„å°ä¼™ä¼´éƒ½åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä¹‹å‰æ–‡ç« ä¸­å…³äº diff å’Œ patch æ˜¯åˆ†æˆä¸¤ä¸ªæ­¥éª¤æ¥å®ç°çš„ã€‚è€Œ `vue` ä¸­åˆ™æ˜¯å°† diff å’Œ patch æ“ä½œåˆäºŒä¸ºä¸€äº†ã€‚ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œ`vue` ä¸­å¯¹äºè¿™å—å…·ä½“æ˜¯å¦‚ä½•å¤„ç†çš„

```javascript
function patch (oldVnode, vnode) {
  // å¦‚æœè€èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥åˆ›å»ºæ–°èŠ‚ç‚¹
  if (isUndef(oldVnode)) {
    if (isDef(vnode)) createElm(vnode)
  // å¦‚æœè€èŠ‚ç‚¹å­˜åœ¨ï¼Œæ–°èŠ‚ç‚¹å´ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥ç§»é™¤è€èŠ‚ç‚¹
  } else if (isUndef(vnode)) {
    const oldElm = oldVnode.elm
    const parentElm = nodeOps.parentNode(oldElm)
    removeVnodes(parentElm, , 0, [oldVnode].length -1)
  } else {
    const isRealElement = isDef(oldVnode.nodeType)
    // å¦‚æœæ–°æ—§èŠ‚ç‚¹ç›¸åŒï¼Œåˆ™è¿›è¡Œå…·ä½“çš„ patch æ“ä½œ
    if (isRealElement && sameVnode(oldVnode, vnode)) {
      patchVnode(oldVnode, vnode)
    } else {
      // å¦åˆ™åˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œç§»é™¤è€èŠ‚ç‚¹
      createElm(vnode, parentElm, nodeOps.nextSibling(oldElm))
      removeVnodes(parentElm, [oldVnode], 0, 0)
    }
  }
}
```

ç„¶åæˆ‘ä»¬å†çœ‹ `patchVnode` ä¸­é—´ç›¸å…³çš„é€»è¾‘ï¼Œå…ˆçœ‹ä¸‹ï¼Œå‰é¢æåŠçš„ `key` åœ¨è¿™çš„ç”¨å¤„

```javascript
function patchVnode (oldVnode, vnode) {
  // æ–°æ—§èŠ‚ç‚¹å®Œå…¨ä¸€æ ·ï¼Œåˆ™ç›´æ¥ return
  if (oldVnode === vnode) {
    return
  }
  // å¦‚æœæ–°æ—§èŠ‚ç‚¹éƒ½è¢«æ ‡æ³¨é™æ€èŠ‚ç‚¹ï¼Œä¸”èŠ‚ç‚¹çš„ key ç›¸åŒã€‚
  // åˆ™ç›´æ¥å°†è€èŠ‚ç‚¹çš„ componentInstance ç›´æ¥æ‹¿è¿‡æ¥ä¾¿OKäº†
  if (
    isTrue(vnode.isStatic) &&
    isTrue(oldVnode.isStatic) &&
    vnode.key === oldVnode.key
  ) {
    vnode.componentInstance = oldVnode.componentInstance
    return
  }
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹çœ‹ vnode ä¸Šé¢çš„æ–‡æœ¬å†…å®¹æ˜¯å¦‚ä½•è¿›è¡Œå¯¹æ¯”çš„

- è‹¥ vnode ä¸ºéæ–‡æœ¬èŠ‚ç‚¹

```javascript
const elm = vnode.elm = oldVnode.elm
const oldCh = oldVnode.children
const ch = vnode.children
if (isUndef(vnode.text)) {
  // å¦‚æœ oldChï¼Œch éƒ½å­˜åœ¨ä¸”ä¸ç›¸åŒï¼Œåˆ™æ‰§è¡Œ updateChildren å‡½æ•°æ›´æ–°å­èŠ‚ç‚¹
  if (isDef(oldCh) && isDef(ch)) {
    if (oldCh !== ch) updateChildren(elm, oldCh, ch)
  // å¦‚æœåªæœ‰ ch å­˜åœ¨
  } else if (isDef(ch)) {
    // è€èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œå…ˆå°†è€èŠ‚ç‚¹çš„æ–‡æœ¬æ¸…ç©ºï¼Œç„¶åå°† ch æ‰¹é‡æ’å…¥åˆ°èŠ‚ç‚¹ elm ä¸‹
    if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, '')
    addVnodes(elm, null, ch, 0, ch.length - 1)
  // å¦‚æœåªæœ‰ oldCh å­˜åœ¨ï¼Œåˆ™ç›´æ¥æ¸…ç©ºè€èŠ‚ç‚¹
  } else if (isDef(oldCh)) {
    removeVnodes(elm, oldCh, 0, oldCh.length - 1)
  // å¦‚æœ oldChï¼Œch éƒ½ä¸å­˜åœ¨ï¼Œä¸”è€èŠ‚ç‚¹ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œåˆ™åªå°†è€èŠ‚ç‚¹æ–‡æœ¬æ¸…ç©º
  } else if (isDef(oldVnode.text)) {
    nodeOps.setTextContent(elm, '')
  }
}
```

- è‹¥ vnode ä¸ºæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¸”æ–°æ—§èŠ‚ç‚¹æ–‡æœ¬ä¸åŒï¼Œåˆ™ç›´æ¥å°†è®¾ç½®ä¸º vnode çš„æ–‡æœ¬å†…å®¹

```javascript
if (isDef(vnode.text) && oldVnode.text !== vnode.text) {
  nodeOps.setTextContent(elm, vnode.text)
}
```

#### iii. updateChildren

é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹ä¸‹æ–¹æ³•ä¸­å¯¹æ–°æ—§èŠ‚ç‚¹èµ·å§‹å’Œç»“æŸç´¢å¼•çš„å®šä¹‰

```javascript
function updateChildren (parentElm, oldCh, newCh) {
  let oldStartIdx = 0
  let newStartIdx = 0
  let oldEndIdx = oldCh.length - 1
  let oldStartVnode = oldCh[0]
  let oldEndVnode = oldCh[oldEndIdx]
  let newEndIdx = newCh.length - 1
  let newStartVnode = newCh[0]
  let newEndVnode = newCh[newEndIdx]
  let oldKeyToIdx, idxInOld, vnodeToMove, refElm
}
```

ç›´æ¥ç”»å¼ å›¾æ¥ç†è§£ä¸‹

![](https://user-gold-cdn.xitu.io/2019/4/8/169fcd81a7e97511?w=946&h=450&f=png&s=30803)

ç´§æ¥ç€å°±æ˜¯ä¸€ä¸ª `while` å¾ªç¯è®©æ–°æ—§èŠ‚ç‚¹èµ·å§‹å’Œç»“æŸç´¢å¼•ä¸æ–­å¾€ä¸­é—´é æ‹¢

```javascript
while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx)
```

è‹¥ `oldStartVnode` æˆ–è€… `oldEndVnode` ä¸å­˜åœ¨ï¼Œåˆ™å¾€ä¸­é—´é æ‹¢

```javascript
if (isUndef(oldStartVnode)) {
  oldStartVnode = oldCh[++oldStartIdx] // Vnode has been moved left
} else if (isUndef(oldEndVnode)) {
  oldEndVnode = oldCh[--oldEndIdx]
}
```

æ¥ä¸‹æ¥å°±æ˜¯ `oldStartVnode` ï¼Œ`newStartVnode`ï¼Œ`oldEndVnode`ï¼Œ`newEndVnode` ä¸¤ä¸¤å¯¹æ¯”çš„å››ç§æƒ…å†µäº†

```javascript
// oldStartVnode å’Œ newStartVnode ä¸º sameVnodeï¼Œè¿›è¡Œ patchVnode
// oldStartIdx å’Œ newStartIdx å‘åç§»åŠ¨ä¸€ä½
else if (sameVnode(oldStartVnode, newStartVnode)) {
  patchVnode(oldStartVnode, newStartVnode)
  oldStartVnode = oldCh[++oldStartIdx]
  newStartVnode = newCh[++newStartIdx]
// oldEndVnode å’Œ newEndVnode ä¸º sameVnodeï¼Œè¿›è¡Œ patchVnode
// oldEndIdx å’Œ newEndIdx å‘å‰ç§»åŠ¨ä¸€ä½
} else if (sameVnode(oldEndVnode, newEndVnode)) {
  patchVnode(oldEndVnode, newEndVnode)
  oldEndVnode = oldCh[--oldEndIdx]
  newEndVnode = newCh[--newEndIdx]
// oldStartVnode å’Œ newEndVnode ä¸º sameVnodeï¼Œè¿›è¡Œ patchVnode
// å°† oldStartVnode.elm æ’å…¥åˆ° oldEndVnode.elm èŠ‚ç‚¹åé¢
// oldStartIdx å‘åç§»åŠ¨ä¸€ä½ï¼ŒnewEndIdx å‘å‰ç§»åŠ¨ä¸€ä½
} else if (sameVnode(oldStartVnode, newEndVnode)) { // Vnode moved right
  patchVnode(oldStartVnode, newEndVnode)
  nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))
  oldStartVnode = oldCh[++oldStartIdx]
  newEndVnode = newCh[--newEndIdx]
// åŒç†ï¼ŒoldEndVnode å’Œ newStartVnode ä¸º sameVnodeï¼Œè¿›è¡Œ patchVnode
// å°† oldEndVnode.elm æ’å…¥åˆ° oldStartVnode.elm å‰é¢
// oldEndIdx å‘å‰ç§»åŠ¨ä¸€ä½ï¼ŒnewStartIdx å‘åç§»åŠ¨ä¸€ä½
} else if (sameVnode(oldEndVnode, newStartVnode)) { // Vnode moved left
  patchVnode(oldEndVnode, newStartVnode)
  nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)
  oldEndVnode = oldCh[--oldEndIdx]
  newStartVnode = newCh[++newStartIdx]
}
```

ç”¨å¼ å›¾æ¥æ€»ç»“ä¸Šé¢çš„æµç¨‹

![](https://user-gold-cdn.xitu.io/2019/4/8/169fcd90d67ba003?w=949&h=598&f=png&s=67999)

å½“ä»¥ä¸Šæ¡ä»¶éƒ½ä¸æ»¡è¶³çš„æƒ…å†µï¼Œåˆ™è¿›è¡Œå…¶ä»–æ“ä½œã€‚

åœ¨çœ‹å…¶ä»–æ“ä½œå‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å‡½æ•° `createKeyToOldIdx`ï¼Œå®ƒçš„ä½œç”¨ä¸»è¦æ˜¯ `return` å‡º `oldCh` ä¸­ `key` å’Œ `index` å”¯ä¸€å¯¹åº”çš„ `map` è¡¨ï¼Œæ ¹æ® `key`ï¼Œåˆ™èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„æ‰¾å‡ºç›¸åº” `key` åœ¨æ•°ç»„ä¸­å¯¹åº”çš„ç´¢å¼•

```javascript
function createKeyToOldIdx (children, beginIdx, endIdx) {
  let i, key
  const map = {}
  for (i = beginIdx; i <= endIdx; ++i) {
    key = children[i].key
    if (isDef(key)) map[key] = i
  }
  return map
}
```

é™¤æ­¤ä¹‹å¤–ï¼Œè¿™å—è¿˜æœ‰å¦å¤–ä¸€ä¸ªè¾…åŠ©å‡½æ•° `findIdxInOld` ï¼Œç”¨æ¥æ‰¾å‡º `newStartVnode`  åœ¨ `oldCh` æ•°ç»„ä¸­å¯¹åº”çš„ç´¢å¼•

```javascript
function findIdxInOld (node, oldCh, start, end) {
  for (let i = start; i < end; i++) {
    const c = oldCh[i]
    if (isDef(c) && sameVnode(node, c)) return i
  }
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶çš„å…·ä½“å¤„ç†

```javascript
else {
  // å¦‚æœ oldKeyToIdx ä¸å­˜åœ¨ï¼Œåˆ™å°† oldCh è½¬æ¢æˆ key å’Œ index å¯¹åº”çš„ map è¡¨
  if (isUndef(oldKeyToIdx)) oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx)
  idxInOld = isDef(newStartVnode.key)
    ? oldKeyToIdx[newStartVnode.key]
    : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
  // å¦‚æœ idxInOld ä¸å­˜åœ¨ï¼Œå³è€èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨ä¸ newStartVnode å¯¹åº” key çš„èŠ‚ç‚¹ï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹
  if (isUndef(idxInOld)) { // New element
    createElm(newStartVnode, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
  } else {
    vnodeToMove = oldCh[idxInOld]
    // åœ¨ oldCh æ‰¾åˆ°äº†å¯¹åº” key çš„èŠ‚ç‚¹ï¼Œä¸”è¯¥èŠ‚ç‚¹ä¸ newStartVnode ä¸º sameVnodeï¼Œåˆ™è¿›è¡Œ patchVnode
    // å°† oldCh è¯¥ä½ç½®çš„èŠ‚ç‚¹æ¸…ç©ºæ‰ï¼Œå¹¶åœ¨ parentElm ä¸­å°† vnodeToMove æ’å…¥åˆ° oldStartVnode.elm å‰é¢
    if (sameVnode(vnodeToMove, newStartVnode)) {
      patchVnode(vnodeToMove, newStartVnode)
      oldCh[idxInOld] = undefined
      nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm)
    } else {
      // æ‰¾åˆ°äº†å¯¹åº”çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯å´å±äºä¸åŒçš„ element å…ƒç´ ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹
      createElm(newStartVnode, parentElm, oldStartVnode.elm, false, newCh, newStartIdx)
    }
  }
  // newStartIdx å‘åç§»åŠ¨ä¸€ä½
  newStartVnode = newCh[++newStartIdx]
}
```

ç»è¿‡è¿™ä¸€ç³»åˆ—çš„æ“ä½œï¼Œåˆ™å®Œæˆäº†èŠ‚ç‚¹ä¹‹é—´çš„ `diff` å’Œ `patch` æ“ä½œï¼Œå³å®Œæˆäº† `oldVnode` å‘ `newVnode` è½¬æ¢çš„æ“ä½œã€‚

æ–‡ç« åˆ°è¿™é‡Œä¹Ÿè¦å‘Šä¸€æ®µè½äº†ï¼Œçœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹ `vue` ä¸­çš„ `vdom` è¿™å—ä¹Ÿä¸€å®šæœ‰äº†è‡ªå·±çš„ç†è§£äº†ã€‚
é‚£ä¹ˆï¼Œæˆ‘ä»¬å†å›åˆ°æ–‡ç« å¼€å¤´æˆ‘ä»¬æŠ›å‡ºçš„é—®é¢˜ï¼Œå¤§å®¶çŸ¥é“ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜äº†ä¹ˆï¼Ÿ

emmmï¼Œå¦‚æœæƒ³è¦ç»§ç»­æ²Ÿé€šæ­¤é—®é¢˜ï¼Œæ¬¢è¿å¤§å®¶åŠ ç¾¤è¿›è¡Œè®¨è®ºï¼Œå‰ç«¯å¤§æ‚çƒ©ï¼š731175396ã€‚å°ä¼™ä¼´ä»¬è®°å¾—åŠ ç¾¤å“¦ï¼Œå“ªæ€•ä¸€èµ·æ¥æ°´ç¾¤ä¹Ÿæ˜¯å¥½çš„å•Š ~ ï¼ˆæ³¨ï¼šç¾¤é‡Œå•èº«æ¼‚äº®å¦¹çº¸çœŸçš„å¾ˆå¤šå“¦ï¼Œå½“ç„¶å¸…å“¥ä¹Ÿå¾ˆå¤šï¼Œæ¯”å¦‚ã€‚ã€‚ã€‚meï¼‰

![](https://user-gold-cdn.xitu.io/2019/4/8/169fcdf0366fc1b1?w=60&h=49&f=jpeg&s=1430)